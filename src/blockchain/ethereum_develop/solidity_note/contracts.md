---
title: Solidity è¯¾å ‚ç¬”è®°è¡¥å…… - åˆçº¦
category:
  - åŒºå—é“¾
  - ä»¥å¤ªåŠ
  - Solidity
---

# Solidity è¯¾å ‚ç¬”è®°è¡¥å…… - åˆçº¦

- [åˆçº¦](https://docs.soliditylang.org/zh-cn/latest/contracts.html#contracts)

## åˆ›å»ºåˆçº¦

### âš™ï¸ åˆçº¦åˆ›å»ºçš„æµç¨‹å’Œè§„åˆ™

1. **å¤–éƒ¨åˆ›å»º vs å†…éƒ¨åˆ›å»º**

   * ä¸€ä¸ªåˆçº¦å¯ä»¥é€šè¿‡å¤–éƒ¨äº¤æ˜“è¢«åˆ›å»ºï¼ˆæ¯”å¦‚ç”¨æˆ·åœ¨é’±åŒ…é‡Œéƒ¨ç½²åˆçº¦ï¼‰ã€‚
   * æˆ–è€…ä¸€ä¸ªåˆçº¦é‡Œè°ƒç”¨å…¶ä»–åˆçº¦åˆ›å»ºåˆçº¦ï¼ˆå†…éƒ¨åˆ›å»ºï¼‰ã€‚

2. **IDE å’Œ web3.js è¾…åŠ©**

   * å·¥å…·å¦‚ Remix ç­‰ IDE æä¾› UIï¼Œä½¿éƒ¨ç½²è¿‡ç¨‹å¯¹ç”¨æˆ·æ¥è¯´æ¯”è¾ƒæ— ç¼ï¼ˆç•Œé¢åŒ–ï¼‰ã€‚
   * ç”¨ JavaScript APIï¼Œä¾‹å¦‚ `web3.eth.Contract` å¯ä»¥ç¨‹åºæ€§åœ°åˆ›å»ºåˆçº¦ã€‚ 

3. **æ„é€ å‡½æ•°ï¼ˆconstructorï¼‰**

   * æ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªç‰¹æ®Šå‡½æ•°ï¼Œç”¨ `constructor` å…³é”®å­—å£°æ˜çš„ã€‚åˆ›å»ºåˆçº¦æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
   * å®ƒæ˜¯å¯é€‰çš„ï¼›å¦‚æœä¸å†™å°±å½“ä½œ â€œé»˜è®¤æ„é€ å‡½æ•°â€ å¤„ç†ã€‚
   * ä¸€ä¸ªåˆçº¦åªèƒ½æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼ˆä¸æ”¯æŒé‡è½½ï¼‰ã€‚
4. **éƒ¨ç½²åå­˜å‚¨åœ¨åŒºå—é“¾ä¸Šçš„ä»£ç **

   * æ„é€ å‡½æ•°æ‰§è¡Œå®Œåï¼Œåˆçº¦æœ€ç»ˆçš„ *runtime code* è¢«å­˜å‚¨åœ¨åŒºå—é“¾ä¸Šã€‚è¿™ä¸ª runtime code åŒ…å«æ‰€æœ‰å…¬å¼€çš„ï¼ˆpublic / externalï¼‰å‡½æ•°ï¼Œä»¥åŠé‚£äº›ä»è¿™äº›å‡½æ•°å¯ä»¥ reachï¼ˆè°ƒç”¨ï¼‰åˆ°çš„å‡½æ•°ã€‚
   * ä¸åŒ…æ‹¬æ„é€ å‡½æ•°æœ¬èº«ï¼ˆconstructorï¼‰é‡Œçš„ä»£ç ï¼Œä¹Ÿä¸åŒ…æ‹¬é‚£äº›åªåœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨çš„å†…éƒ¨å‡½æ•°ï¼ˆinternal å‡½æ•°ä»…åœ¨ constructor è°ƒç”¨åå¦‚æœæ²¡æœ‰è¢«å…¶å®ƒå…¬å¼€ï¼å¤–éƒ¨å‡½æ•°å¼•ç”¨ï¼Œä¹Ÿä¸ä¼šåŒ…æ‹¬åœ¨éƒ¨ç½²åçš„ runtime code ä¸­ï¼‰ã€‚

5. **æ„é€ å‡½æ•°å‚æ•°çš„ä¼ é€’**

   * æ„é€ å‡½æ•°çš„å‚æ•°åœ¨å†…éƒ¨æ˜¯é€šè¿‡ ABI ç¼–ç ï¼ˆABI-encodedï¼‰é™„åŠ åœ¨åˆçº¦å­—èŠ‚ç ä¹‹åä¼ é€’çš„ã€‚éƒ¨ç½²å·¥å…·ï¼ˆå¦‚ web3.jsï¼‰ä¸€èˆ¬å°è£…äº†è¿™äº›ç»†èŠ‚ï¼Œä½ ä¸ç”¨æ‰‹åŠ¨å¤„ç†ã€‚

6. **åˆ›å»ºåˆçº¦ä¾èµ–å…³ç³»**

   * å¦‚æœä¸€ä¸ªåˆçº¦è¦åˆ›å»ºå¦ä¸€ä¸ªåˆçº¦ï¼Œé‚£ä¹ˆåˆ›å»ºè€…ï¼ˆcallerï¼‰å¿…é¡»çŸ¥é“è¦åˆ›å»ºåˆçº¦çš„æºä»£ç æˆ–ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶ã€‚æ¢å¥è¯è¯´ï¼Œ**å¾ªç¯ä¾èµ–**ï¼ˆcontract A åˆ›å»º Bï¼ŒB åˆ›å»º Aï¼‰åœ¨ä»£ç çº§é€šå¸¸æ˜¯ä¸å¯è¡Œçš„ / ä¸å…è®¸çš„ã€‚
---

## å¯è§æ€§å’Œ getter å‡½æ•°

### çŠ¶æ€å˜é‡å¯è§æ€§

| å¯è§æ€§ | åŒä¸€åˆçº¦å†…è®¿é—® | æ´¾ç”Ÿåˆçº¦è®¿é—® | å¤–éƒ¨åˆçº¦è®¿é—® | è‡ªåŠ¨ç”Ÿæˆgetter | å¤‡æ³¨ |
|--------|---------------|-------------|-------------|---------------|------|
| `public` | âœ… | âœ… | âœ… | âœ… | ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆgetterå‡½æ•°ï¼Œæ— setter |
| `internal` | âœ… | âœ… | âŒ | âŒ | **é»˜è®¤å¯è§æ€§**ï¼Œåªèƒ½å†…éƒ¨å’Œæ´¾ç”Ÿåˆçº¦è®¿é—® |
| `private` | âœ… | âŒ | âŒ | âŒ | åªèƒ½åœ¨å®šä¹‰çš„åˆçº¦ä¸­è®¿é—® |

### å‡½æ•°å¯è§æ€§

| å¯è§æ€§ | åŒä¸€åˆçº¦å†…è®¿é—® | æ´¾ç”Ÿåˆçº¦è®¿é—® | å¤–éƒ¨åˆçº¦è®¿é—® | è°ƒç”¨æ–¹å¼ | å¤‡æ³¨ |
|--------|---------------|-------------|-------------|----------|------|
| `external` | âŒ (éœ€è¦`this.f()`) | âœ… | âœ… | æ¶ˆæ¯è°ƒç”¨ | åˆçº¦æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œä¸èƒ½ç›´æ¥å†…éƒ¨è°ƒç”¨ |
| `public` | âœ… | âœ… | âœ… | å†…éƒ¨/æ¶ˆæ¯è°ƒç”¨ | åˆçº¦æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œå¯å†…éƒ¨å’Œå¤–éƒ¨è°ƒç”¨ |
| `internal` | âœ… | âœ… | âŒ | å†…éƒ¨è°ƒç”¨ | ä¸é€šè¿‡ABIæš´éœ²ï¼Œå¯æ¥å—å†…éƒ¨ç±»å‹å‚æ•° |
| `private` | âœ… | âŒ | âŒ | å†…éƒ¨è°ƒç”¨ | åªèƒ½åœ¨å®šä¹‰çš„åˆçº¦ä¸­è®¿é—® |


:::tip
#### é‡è¦æé†’

âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼šæ ‡è®°ä¸º `private` æˆ– `internal` çš„å˜é‡å’Œå‡½æ•°ä»ç„¶ä¼šåœ¨åŒºå—é“¾ä¸Šå…¬å¼€å¯è§ï¼Œè¿™äº›ä¿®é¥°ç¬¦åªæ˜¯é˜²æ­¢å…¶ä»–åˆçº¦çš„ç¨‹åºåŒ–è®¿é—®ã€‚

#### *è°ƒç”¨æ–¹å¼è¯´æ˜

- **å†…éƒ¨è°ƒç”¨**ï¼šç›´æ¥å‡½æ•°è°ƒç”¨ï¼Œä¸åˆ›å»ºEVMæ¶ˆæ¯è°ƒç”¨
- **æ¶ˆæ¯è°ƒç”¨**ï¼šé€šè¿‡EVMæ¶ˆæ¯è°ƒç”¨ï¼Œå¦‚ `this.f()` æˆ–ä»å…¶ä»–åˆçº¦è°ƒç”¨
:::

### Getterå‡½æ•°

#### åŸºæœ¬è§„åˆ™
- ç¼–è¯‘å™¨ä¸ºæ‰€æœ‰ `public` çŠ¶æ€å˜é‡è‡ªåŠ¨ç”ŸæˆåŒåçš„ getter å‡½æ•°
- Getter å‡½æ•°å…·æœ‰ `external` å¯è§æ€§
- çŠ¶æ€å˜é‡å¯ä»¥åœ¨å£°æ˜æ—¶åˆå§‹åŒ–

```solidity
uint public data = 42;  // è‡ªåŠ¨ç”Ÿæˆ function data() external view returns (uint)
```

#### è®¿é—®æ–¹å¼å·®å¼‚

| è®¿é—®æ–¹å¼ | è¯­æ³• | è°ƒç”¨ç±»å‹ | è¯´æ˜ |
|---------|------|---------|------|
| å†…éƒ¨è®¿é—® | `data` | ç›´æ¥è¯»å–çŠ¶æ€å˜é‡ | ä¸ä½¿ç”¨ `this.` |
| å¤–éƒ¨è®¿é—® | `this.data()` | è°ƒç”¨ getter å‡½æ•° | ä½¿ç”¨ `this.` æˆ–ä»å…¶ä»–åˆçº¦è°ƒç”¨ |

#### å¤æ‚ç±»å‹çš„ Getter å‡½æ•°

##### æ•°ç»„ç±»å‹
- **é™åˆ¶**ï¼šåªèƒ½è·å–å•ä¸ªå…ƒç´ ï¼Œä¸èƒ½è¿”å›æ•´ä¸ªæ•°ç»„
- **åŸå› **ï¼šé¿å…é«˜é¢ Gas è´¹ç”¨
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ‰‹åŠ¨ç¼–å†™è¿”å›æ•´ä¸ªæ•°ç»„çš„å‡½æ•°

```solidity
uint[] public myArray;
// è‡ªåŠ¨ç”Ÿæˆï¼šfunction myArray(uint i) external view returns (uint)

// æ‰‹åŠ¨æ·»åŠ è·å–æ•´ä¸ªæ•°ç»„çš„å‡½æ•°
function getArray() public view returns (uint[] memory) {
    return myArray;
}
```

##### æ˜ å°„å’Œç»“æ„ä½“
- **å¤æ‚æ˜ å°„**ï¼š`mapping(uint => mapping(bool => Data[])) public data`
- **ç”Ÿæˆçš„ getter**ï¼šä¼šä¸ºæ¯å±‚æ˜ å°„å’Œæ•°ç»„æä¾›å‚æ•°
- **é™åˆ¶**ï¼šç»“æ„ä½“ä¸­çš„æ˜ å°„å’ŒåŠ¨æ€æ•°ç»„ä¼šè¢«çœç•¥ï¼ˆbytes é™¤å¤–ï¼‰
- **åŸå› **ï¼šæ— æ³•ä¸ºæ˜ å°„æä¾›åˆé€‚çš„é”®é€‰æ‹©æœºåˆ¶

**å¤æ‚ç»“æ„ä½“ç¤ºä¾‹ï¼š**
```solidity
struct Data {
    uint a;           // âœ… åŒ…å«åœ¨ getter ä¸­
    bytes3 b;         // âœ… åŒ…å«åœ¨ getter ä¸­  
    mapping(uint => uint) map;  // âŒ çœç•¥ï¼ˆæ˜ å°„æ— æ³•é€‰æ‹©é”®ï¼‰
    uint[3] c;        // âŒ çœç•¥ï¼ˆå›ºå®šæ•°ç»„ï¼‰
    uint[] d;         // âŒ çœç•¥ï¼ˆåŠ¨æ€æ•°ç»„ï¼‰
    bytes e;          // âœ… åŒ…å«åœ¨ getter ä¸­ï¼ˆbytes ä¾‹å¤–ï¼‰
}
mapping(uint => mapping(bool => Data[])) public data;
```

**ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ getter å‡½æ•°ï¼š**
```solidity
function data(uint arg1, bool arg2, uint arg3)
    public
    view
    returns (uint a, bytes3 b, bytes memory e)
{
    a = data[arg1][arg2][arg3].a;
    b = data[arg1][arg2][arg3].b;
    e = data[arg1][arg2][arg3].e;
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `arg1`: ç¬¬ä¸€å±‚æ˜ å°„çš„é”® (uint)
- `arg2`: ç¬¬äºŒå±‚æ˜ å°„çš„é”® (bool) 
- `arg3`: æ•°ç»„çš„ç´¢å¼• (uint)
- **è¿”å›å€¼**: åªåŒ…å«ç»“æ„ä½“ä¸­å¯è®¿é—®çš„å­—æ®µ (a, b, e)

## å‡½æ•°ä¿®é¥°å™¨

**ä¿®é¥°å™¨æ˜¯ç”¨æ¥å£°æ˜å¼æ”¹å˜å‡½æ•°è¡Œä¸ºçš„å·¥å…·**ï¼Œä¸»è¦ç”¨äºï¼š
- æƒé™æ§åˆ¶ï¼ˆå¦‚`onlyOwner`æ£€æŸ¥è°ƒç”¨è€…èº«ä»½ï¼‰
- æ¡ä»¶æ£€æŸ¥ï¼ˆå¦‚`costs`æ£€æŸ¥æ”¯ä»˜é‡‘é¢ï¼‰
- çŠ¶æ€ä¿æŠ¤ï¼ˆå¦‚`noReentrancy`é˜²é‡å…¥æ”»å‡»ï¼‰

### æ ¸å¿ƒè¯­æ³•ç‰¹æ€§

#### 1. åŸºæœ¬ç»“æ„
```solidity
modifier modifierName {
    require(condition, "Error message");
    _;  // å ä½ç¬¦ï¼Œå‡½æ•°ä½“æ’å…¥ä½ç½®
}
```

#### 2. å‚æ•°åŒ–ä¿®é¥°å™¨
```solidity
modifier costs(uint price) {
    if (msg.value >= price) {
        _;
    }
}
```

#### 3. ç»§æ‰¿æ€§
- ä¿®é¥°å™¨å¯ä»¥è¢«æ´¾ç”Ÿåˆçº¦ç»§æ‰¿
- æ ‡è®°ä¸º`virtual`æ—¶å¯è¢«é‡å†™
- å¯é€šè¿‡`C.m`è¯­æ³•å¼•ç”¨ç‰¹å®šåˆçº¦çš„ä¿®é¥°å™¨

### æ‰§è¡Œæœºåˆ¶

#### 1. å ä½ç¬¦`_`çš„ä½œç”¨
- è¡¨ç¤ºè¢«ä¿®é¥°å‡½æ•°ä½“çš„æ’å…¥ä½ç½®
- å¯åœ¨ä¿®é¥°å™¨ä¸­å¤šæ¬¡ä½¿ç”¨
- æ¯æ¬¡å‡ºç°éƒ½ä¼šæ‰§è¡Œä¸€éå‡½æ•°ä½“

#### 2. å¤šä¿®é¥°å™¨æ‰§è¡Œé¡ºåº
```solidity
function register() public payable costs(price) onlyOwner {
    // æŒ‰ä»å·¦åˆ°å³é¡ºåºæ‰§è¡Œï¼šå…ˆcostsï¼Œå†onlyOwner
}
```

#### 3. è¿”å›å€¼å¤„ç†
- ä¿®é¥°å™¨ä¸­çš„`return`åªé€€å‡ºå½“å‰ä¿®é¥°å™¨
- å‡½æ•°çš„æœ€ç»ˆè¿”å›å€¼æ˜¯æœ€åä¸€æ¬¡æ‰§è¡Œçš„ç»“æœ
- å¦‚æœä¿®é¥°å™¨ä¸æ‰§è¡Œ`_`ï¼Œè¿”å›å˜é‡ä¸ºé»˜è®¤å€¼

### å®ç”¨åœºæ™¯ç¤ºä¾‹

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.7.1 <0.9.0;
// è¿™å°†æŠ¥å‘Šä¸€ä¸ªç”±äºåºŸå¼ƒçš„ selfdestruct è€Œäº§ç”Ÿçš„è­¦å‘Š

contract owned {
    constructor() { owner = payable(msg.sender); }
    address payable owner;

    // è¿™ä¸ªåˆçº¦åªå®šä¹‰äº†ä¸€ä¸ªä¿®é¥°å™¨ï¼Œä½†æ²¡æœ‰ä½¿ç”¨å®ƒï¼š
    // å®ƒå°†åœ¨æ´¾ç”Ÿåˆçº¦ä¸­ä½¿ç”¨ã€‚
    // ä¿®é¥°å™¨æ‰€ä¿®é¥°çš„å‡½æ•°ä½“ä¼šè¢«æ’å…¥åˆ°ç‰¹æ®Šç¬¦å· `_;` çš„ä½ç½®ã€‚
    // è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‰€æœ‰è€…è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«æ‰§è¡Œï¼Œ
    // å¦åˆ™å°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚
    modifier onlyOwner {
        require(
            msg.sender == owner,
            "Only owner can call this function."
        );
        _;
    }
}

contract destructible is owned {
    // è¿™ä¸ªåˆçº¦ä» `owned` åˆçº¦ç»§æ‰¿äº† `onlyOwner` ä¿®é¥°å™¨ï¼Œ
    // å¹¶å°†å…¶åº”ç”¨äº `destroy` å‡½æ•°ï¼Œ
    // åªæœ‰åœ¨åˆçº¦é‡Œä¿å­˜çš„ owner è°ƒç”¨ `destroy` å‡½æ•°ï¼Œæ‰ä¼šç”Ÿæ•ˆã€‚
    function destroy() public onlyOwner {
        selfdestruct(owner);
    }
}

contract priced {
    // ä¿®é¥°å™¨å¯ä»¥æ¥å—å‚æ•°ï¼š
    modifier costs(uint price) {
        if (msg.value >= price) {
            _;
        }
    }
}

contract Register is priced, destructible {
    mapping(address => bool) registeredAddresses;
    uint price;

    constructor(uint initialPrice) { price = initialPrice; }

    // åœ¨è¿™é‡Œä¹Ÿä½¿ç”¨å…³é”®å­— `payable` éå¸¸é‡è¦ï¼Œ
    // å¦åˆ™å‡½æ•°ä¼šè‡ªåŠ¨æ‹’ç»æ‰€æœ‰å‘é€ç»™å®ƒçš„ä»¥å¤ªå¸ã€‚
    function register() public payable costs(price) {
        registeredAddresses[msg.sender] = true;
    }

    /*
        æ‰§è¡Œè¿‡ç¨‹
        // === onlyOwnerä¿®é¥°å™¨çš„å‰ç½®é€»è¾‘ ===
        require(
            msg.sender == owner,
            "Only owner can call this function."
        );
        
        // === è¿™é‡Œæ˜¯ `_` å ä½ç¬¦çš„ä½ç½® ===
        // åŸå§‹å‡½æ•°ä½“ä¼šè¢«æ’å…¥åˆ°è¿™é‡Œï¼š
        price = price_;
        // === å‡½æ•°ä½“æ’å…¥ç»“æŸ ===
        
        // === onlyOwnerä¿®é¥°å™¨çš„åç½®é€»è¾‘ï¼ˆæœ¬ä¾‹ä¸­æ²¡æœ‰ï¼‰===
    */
    function changePrice(uint price_) public onlyOwner {
        price = price_;
    }
}

contract Mutex {
    bool locked;
    modifier noReentrancy() {
        require(
            !locked,
            "Reentrant call."
        );
        locked = true;
        _;
        locked = false;
    }

    /// è¿™ä¸ªå‡½æ•°å—äº’æ–¥é‡ä¿æŠ¤ï¼Œè¿™æ„å‘³ç€ `msg.sender.call` ä¸­çš„é‡å…¥è°ƒç”¨ä¸èƒ½å†æ¬¡è°ƒç”¨  `f`ã€‚
    /// `return 7` è¯­å¥æŒ‡å®šè¿”å›å€¼ä¸º 7ï¼Œä½†ä¿®é¥°å™¨ä¸­çš„è¯­å¥ `locked = false` ä»ä¼šæ‰§è¡Œã€‚
    function f() public noReentrancy returns (uint) {
        (bool success,) = msg.sender.call("");
        require(success);
        return 7;
    }
}
```

## å¸¸é‡å’Œä¸å¯å˜çŠ¶æ€å˜é‡

### åŸºæœ¬ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | Constant | Immutable |
|------|----------|-----------|
| **ä¿®æ”¹æ€§** | åˆçº¦æ„å»ºåä¸èƒ½ä¿®æ”¹ | åˆçº¦æ„å»ºåä¸èƒ½ä¿®æ”¹ |
| **èµ‹å€¼æ—¶æœº** | ç¼–è¯‘æ—¶å¿…é¡»å›ºå®š | æ„é€ æ—¶å¯ä»¥åˆ†é… |
| **å£°æ˜ä½ç½®** | å¯åœ¨æ–‡ä»¶çº§åˆ«æˆ–åˆçº¦å†…å£°æ˜ | åªèƒ½åœ¨åˆçº¦å†…å£°æ˜ |
| **å­˜å‚¨æ–¹å¼** | ç¼–è¯‘å™¨ä¸é¢„ç•™å­˜å‚¨ç©ºé—´ï¼Œæ¯æ¬¡å‡ºç°éƒ½è¢«æ›¿æ¢ä¸ºå¸¸é‡è¡¨è¾¾å¼ | æ„é€ æ—¶è¯„ä¼°ä¸€æ¬¡ï¼Œå€¼è¢«å¤åˆ¶åˆ°ä»£ç ä¸­æ‰€æœ‰è®¿é—®ä½ç½® |

### èµ‹å€¼è§„åˆ™å¯¹æ¯”

| èµ‹å€¼è§„åˆ™ | Constant | Immutable |
|----------|----------|-----------|
| **èµ‹å€¼ä½ç½®** | å¿…é¡»åœ¨å˜é‡å£°æ˜å¤„ | å¯åœ¨å£°æ˜å¤„æˆ–æ„é€ å‡½æ•°ä¸­ |
| **èµ‹å€¼æ¬¡æ•°** | å£°æ˜æ—¶ä¸€æ¬¡ | æ„é€ æ—¶å¯å¤šæ¬¡èµ‹å€¼ |
| **è®¿é—®é™åˆ¶** | ä¸å…è®¸è®¿é—®å­˜å‚¨ã€åŒºå—é“¾æ•°æ®ã€æ‰§è¡Œæ•°æ®ã€å¤–éƒ¨åˆçº¦è°ƒç”¨ | æ„é€ æ—¶å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `msg.sender`ã€`ref.balance`ï¼‰ |
| **å…è®¸çš„å‡½æ•°** | `keccak256`ã€`sha256`ã€`ripemd160`ã€`ecrecover`ã€`addmod`ã€`mulmod` | æ— ç‰¹æ®Šé™åˆ¶ |

### æ”¯æŒçš„æ•°æ®ç±»å‹

| ç±»å‹æ”¯æŒ | Constant | Immutable |
|----------|----------|-----------|
| **å­—ç¬¦ä¸²ç±»å‹** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **å€¼ç±»å‹** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å…¶ä»–ç±»å‹** | âŒ å½“å‰æœªå®Œå…¨å®ç° | âŒ å½“å‰æœªå®Œå…¨å®ç° |

### ç‡ƒæ–™æˆæœ¬å¯¹æ¯”

| æˆæœ¬å› ç´  | Constant | Immutable |
|----------|----------|-----------|
| **ç›¸å¯¹æˆæœ¬** | é€šå¸¸æ›´ä¾¿å®œ | ç›¸å¯¹è¾ƒé«˜ |
| **å­˜å‚¨å ç”¨** | 0 å­—èŠ‚ï¼ˆç›´æ¥æ›¿æ¢ï¼‰ | 32 å­—èŠ‚ï¼ˆå³ä½¿å€¼æ›´å°ï¼‰ |
| **ä¼˜åŒ–ç¨‹åº¦** | å±€éƒ¨ä¼˜åŒ–å¯èƒ½æ€§é«˜ | ä¸€æ¬¡è¯„ä¼°ï¼Œå…¨å±€å¤åˆ¶ |

### ä»£ç ç¤ºä¾‹å¯¹æ¯”

#### Constant ç¤ºä¾‹
```solidity
// æ–‡ä»¶çº§åˆ«å¸¸é‡
uint constant X = 32**22 + 8;

contract C {
    // å­—ç¬¦ä¸²å¸¸é‡
    string constant TEXT = "abc";
    // å“ˆå¸Œå¸¸é‡
    bytes32 constant MY_HASH = keccak256("abc");
}
```

#### Immutable ç¤ºä¾‹
```solidity
contract C {
    uint immutable decimals = 18;  // å£°æ˜æ—¶åˆå§‹åŒ–
    uint immutable maxBalance;     // æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–
    address immutable owner = msg.sender;  // å¯è®¿é—®ç¯å¢ƒå˜é‡
    
    constructor(uint decimals_, address ref) {
        if (decimals_ != 0)
            decimals = decimals_;  // æ„é€ æ—¶å¯å¤šæ¬¡èµ‹å€¼
        
        maxBalance = ref.balance;  // å¯è®¿é—®å¤–éƒ¨çŠ¶æ€
    }
}
```

### é‡è¦æ³¨æ„äº‹é¡¹

#### Constant æ³¨æ„äº‹é¡¹
- å€¼å¿…é¡»åœ¨ç¼–è¯‘æ—¶å®Œå…¨ç¡®å®š
- ä¸èƒ½è®¿é—®ä»»ä½•è¿è¡Œæ—¶æ•°æ®
- æ”¯æŒå¤æ‚è¡¨è¾¾å¼ä½†æœ‰å‰¯ä½œç”¨é™åˆ¶

#### Immutable æ³¨æ„äº‹é¡¹
- Solidity 0.8.21 å‰é™åˆ¶æ›´ä¸¥æ ¼
- éœ€æ³¨æ„ç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­çš„åˆå§‹åŒ–é¡ºåº
- å¯åœ¨é¦–æ¬¡å†™å…¥å‰è¯»å–ï¼ˆæœ‰é»˜è®¤åˆå§‹å€¼ï¼‰
- ç¼–è¯‘å™¨ä¼šä¿®æ”¹è¿è¡Œæ—¶ä»£ç æ›¿æ¢ä¸å¯å˜å˜é‡å¼•ç”¨

#### ä½¿ç”¨å»ºè®®
- **é€‰æ‹© Constant**ï¼šå½“å€¼åœ¨ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šï¼Œä¸”å¸Œæœ›æœ€ä½ gas æˆæœ¬
- **é€‰æ‹© Immutable**ï¼šå½“éœ€è¦åœ¨éƒ¨ç½²æ—¶æ ¹æ®æ„é€ å‡½æ•°å‚æ•°æˆ–ç¯å¢ƒå˜é‡è®¾ç½®å€¼

## å‡½æ•°

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#functions


### å‡½æ•°é‡å†™çš„é—®é¢˜

**æœ€ä½³å®è·µå»ºè®®**ï¼š
- é¿å…ä½¿ç”¨å‡½æ•°é‡è½½ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ•°å€¼ç±»å‹æ—¶
- ä½¿ç”¨æ¸…æ™°çš„å‡½æ•°å‘½å
- ä¼˜å…ˆè€ƒè™‘å•ä¸€å‡½æ•°å¤„ç†å¤šç§æƒ…å†µ
- å¦‚æœå¿…é¡»é‡è½½ï¼Œç¡®ä¿å‚æ•°ç±»å‹å·®å¼‚è¶³å¤Ÿå¤§ï¼Œé¿å…éšå¼è½¬æ¢å†²çª

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤š Solidity é£æ ¼æŒ‡å—éƒ½å»ºè®®**è°¨æ…ä½¿ç”¨æˆ–é¿å…å‡½æ•°é‡è½½**çš„åŸå› ã€‚


## äº‹ä»¶

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#events

## é”™è¯¯å’Œæ¢å¤è¯­å¥

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#errors


### Gas æˆæœ¬æ’åºï¼ˆä»ä½åˆ°é«˜ï¼‰

| æ–¹å¼ | Gas æˆæœ¬ | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|------|----------|----------|---------|
| `revert` + è‡ªå®šä¹‰é”™è¯¯ | **æœ€ä½** | ç”¨æˆ·è¾“å…¥é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘é”™è¯¯ | âœ… Gasæ•ˆç‡æœ€é«˜<br>âœ… ç»“æ„åŒ–æ•°æ®<br>âœ… æ˜“äºå‰ç«¯è§£æ |
| `require` + è‡ªå®šä¹‰é”™è¯¯ | **ä½** | å‰ç½®æ¡ä»¶æ£€æŸ¥ | âœ… ç®€æ´è¯­æ³•<br>âœ… ç»“æ„åŒ–æ•°æ® |
| `revert` + å­—ç¬¦ä¸² | **ä¸­ç­‰** | ç®€å•é”™è¯¯æç¤º | âŒ Gasæ¶ˆè€—è¾ƒé«˜<br>âœ… æ˜“è¯» |
| `require` + å­—ç¬¦ä¸² | **é«˜** | ä¼ ç»Ÿæ–¹å¼ | âŒ Gasæ¶ˆè€—æœ€é«˜<br>âœ… è¯­æ³•ç®€å• |
| `assert` | **æœ€é«˜**ï¼ˆå¼‚å¸¸æ—¶ï¼‰ | å†…éƒ¨é”™è¯¯æ£€æµ‹ | âŒ æ¶ˆè€—æ‰€æœ‰å‰©ä½™Gas<br>âš ï¸ ä»…ç”¨äºä¸åº”å‘ç”Ÿçš„æƒ…å†µ |

### æœ€ä½³å®è·µå»ºè®®

#### âœ… æ¨èï¼šè‡ªå®šä¹‰é”™è¯¯ + revert
```solidity
// å®šä¹‰é”™è¯¯ç±»å‹
error InsufficientBalance(uint256 available, uint256 required);
error InvalidRecipient(address recipient);
error TransferPaused();

contract BestPractice {
    mapping(address => uint256) private balances;
    bool public paused;
    
    function transfer(address to, uint256 amount) public {
        // ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯
        if (paused) revert TransferPaused();
        if (to == address(0)) revert InvalidRecipient(to);
        if (amount > balances[msg.sender]) {
            revert InsufficientBalance(balances[msg.sender], amount);
        }
        
        balances[msg.sender] -= amount;
        balances[to] += amount;
    }
}
```

#### ğŸ”„ å¯æ¥å—ï¼šrequire + è‡ªå®šä¹‰é”™è¯¯
```solidity
function transfer(address to, uint256 amount) public {
    require(!paused, TransferPaused());
    require(to != address(0), InvalidRecipient(to));
    require(amount <= balances[msg.sender], InsufficientBalance(balances[msg.sender], amount));
    
    balances[msg.sender] -= amount;
    balances[to] += amount;
}
```

#### âŒ ä¸æ¨èï¼šå­—ç¬¦ä¸²é”™è¯¯æ¶ˆæ¯
```solidity
function transfer(address to, uint256 amount) public {
    require(!paused, "Transfer is paused");
    require(to != address(0), "Invalid recipient");
    require(amount <= balances[msg.sender], "Insufficient balance");
    
    balances[msg.sender] -= amount;
    balances[to] += amount;
}
```

#### ä½•æ—¶ä½¿ç”¨ä¸åŒæ–¹å¼

##### `revert` + è‡ªå®šä¹‰é”™è¯¯
- **æœ€æ¨è**çš„ç°ä»£æ–¹å¼
- ç”¨äºï¼šç”¨æˆ·è¾“å…¥é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘è¿è§„
- Gas æ•ˆç‡æœ€é«˜
- æä¾›ç»“æ„åŒ–é”™è¯¯æ•°æ®

##### `require`
- ç”¨äºï¼šç®€å•çš„å‰ç½®æ¡ä»¶æ£€æŸ¥
- è¯­æ³•æ›´ç®€æ´
- ä¸è‡ªå®šä¹‰é”™è¯¯ç»“åˆä½¿ç”¨æ•ˆæœå¥½

##### `assert`
- **ä»…ç”¨äº**ï¼šå†…éƒ¨ä¸å˜é‡æ£€æŸ¥
- ä¸åº”è¯¥ç”¨äºç”¨æˆ·å¯èƒ½è§¦å‘çš„é”™è¯¯
- å¤±è´¥æ—¶æ¶ˆè€—æ‰€æœ‰å‰©ä½™Gas

### å‰ç«¯é›†æˆä¼˜åŠ¿

ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯çš„åˆçº¦æ›´æ˜“äºå‰ç«¯é›†æˆï¼š

```javascript
// å‰ç«¯å¯ä»¥è½»æ¾è§£æç»“æ„åŒ–é”™è¯¯
try {
    await contract.transfer(recipient, amount);
} catch (error) {
    if (error.data && error.data.includes('InsufficientBalance')) {
        const decoded = contract.interface.parseError(error.data);
        console.log(`ä½™é¢ä¸è¶³ï¼šå¯ç”¨ ${decoded.args.available}ï¼Œéœ€è¦ ${decoded.args.required}`);
    }
}
```

### æ€»ç»“

**å¼ºçƒˆæ¨èä½¿ç”¨ï¼š`revert` + è‡ªå®šä¹‰é”™è¯¯**

1. **Gas æ•ˆç‡æœ€é«˜**
2. **ç»“æ„åŒ–æ•°æ®ä¼ é€’**
3. **å‰ç«¯æ˜“äºè§£æ**
4. **ç°ä»£Solidityæœ€ä½³å®è·µ**
5. **ä»£ç å¯è¯»æ€§å¥½**

## ç»§æ‰¿

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#index-17

## æŠ½è±¡åˆçº¦

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#abstract-contract


## æ¥å£ï¼ˆinterfaceï¼‰åˆçº¦

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#interface

## åº“åˆçº¦

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#libraries

## Using For

- https://docs.soliditylang.org/zh-cn/latest/contracts.html#using-for

