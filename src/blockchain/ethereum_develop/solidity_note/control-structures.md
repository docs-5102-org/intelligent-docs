---
title: Solidity è¯¾å ‚ç¬”è®°è¡¥å…… - è¡¨è¾¾å¼å’Œæ§åˆ¶ç»“æ„
category:
  - åŒºå—é“¾
  - ä»¥å¤ªåŠ
  - Solidity
---

# Solidity è¯¾å ‚ç¬”è®°è¡¥å…… - è¡¨è¾¾å¼å’Œæ§åˆ¶ç»“æ„

- [Solidity å®˜ç½‘ - è¡¨è¾¾å¼å’Œæ§åˆ¶ç»“æ„](https://docs.soliditylang.org/zh-cn/latest/control-structures.html#id1)

## æ§åˆ¶ç»“æ„

**ğŸ“Œ å°ç»“**

- Solidity æ§åˆ¶ç»“æ„åœ¨åŸºæœ¬å½¢å¼ä¸Šå’Œ C / JavaScript å¾ˆåƒï¼Œä½†å®ƒä¸¥æ ¼è¦æ±‚æ¡ä»¶ä¸ºå¸ƒå°”ç±»å‹ï¼Œå¿…é¡»åŠ æ‹¬å·ï¼Œå¯¹äºè¯­å¥ä½“çš„å¤§æ‹¬å·æ˜¯å¯é€‰çš„ï¼›å¹¶ä¸”å¼‚å¸¸å¤„ç†ï¼ˆtry/catchï¼‰ä»…é€‚ç”¨äºå¤–éƒ¨è°ƒç”¨å’Œåˆçº¦åˆ›å»ºã€‚
- ä¸ C æˆ– JavaScript ä¸åŒï¼ŒSolidity ä¸å…è®¸éå¸ƒå°”ç±»å‹éšå¼è½¬æ¢æˆå¸ƒå°”ç±»å‹

```solidity
if (1) { â€¦ }   // âŒ åœ¨ Solidity ä¸­æ— æ•ˆ
```

## å‡½æ•°è°ƒç”¨

- [å‡½æ•°è°ƒç”¨](https://docs.soliditylang.org/zh-cn/latest/control-structures.html#function-calls)

### åŠ ç›åˆçº¦åˆ›å»º / create2

Solidityä¸­**åŠ ç›ï¼ˆSaltï¼‰åˆçº¦åˆ›å»º**çš„è¿‡ç¨‹ï¼š

#### ä¸¤ç§åˆçº¦åˆ›å»ºæ–¹å¼å¯¹æ¯”

**1. ä¼ ç»Ÿåˆ›å»ºæ–¹å¼ï¼ˆCREATEï¼‰**
- åˆçº¦åœ°å€ = `keccak256(åˆ›å»ºè€…åœ°å€, nonce)`
- nonceæ˜¯ä¸€ä¸ªé€’å¢è®¡æ•°å™¨ï¼Œæ¯æ¬¡åˆ›å»ºåˆçº¦æ—¶+1
- åœ°å€ä¸å¯é¢„æµ‹ï¼Œå› ä¸ºnonceä¼šå˜åŒ–

**2. åŠ ç›åˆ›å»ºæ–¹å¼ï¼ˆCREATE2ï¼‰**
- ä½¿ç”¨å›ºå®šçš„saltå€¼æ›¿ä»£å˜åŒ–çš„nonce
- åœ°å€å®Œå…¨å¯é¢„æµ‹å’Œç¡®å®š

#### åŠ ç›åˆ›å»ºçš„è¯¦ç»†è¿‡ç¨‹

**åœ°å€è®¡ç®—å…¬å¼**
```
åˆçº¦åœ°å€ = keccak256(
    0xff +                    // å›ºå®šå‰ç¼€
    åˆ›å»ºè€…åœ°å€ +               // è°ƒç”¨create2çš„åˆçº¦åœ°å€
    salt +                    // 32å­—èŠ‚çš„ç›å€¼
    keccak256(åˆ›å»ºå­—èŠ‚ç  + æ„é€ å‚æ•°)  // åˆçº¦ä»£ç å“ˆå¸Œ
)
```

**ä»£ç ç¤ºä¾‹åˆ†æ**

åœ¨æ‚¨çš„ä»£ç ä¸­ï¼š

```solidity
address predictedAddress = address(uint160(uint(keccak256(abi.encodePacked(
    bytes1(0xff),           // å›ºå®šå‰ç¼€
    address(this),          // åˆçº¦Cçš„åœ°å€ï¼ˆåˆ›å»ºè€…ï¼‰
    salt,                   // ä¼ å…¥çš„ç›å€¼
    keccak256(abi.encodePacked(
        type(D).creationCode,   // åˆçº¦Dçš„åˆ›å»ºå­—èŠ‚ç 
        abi.encode(arg)         // æ„é€ å‡½æ•°å‚æ•°
    ))
)))));
```

**å®é™…åˆ›å»º**
```solidity
D d = new D{salt: salt}(arg);  // ä½¿ç”¨CREATE2æ“ä½œç åˆ›å»º
```

**åŠ ç›åˆ›å»ºçš„ä¼˜åŠ¿**

1. **åœ°å€å¯é¢„æµ‹æ€§**
   - åœ¨åˆçº¦éƒ¨ç½²å‰å°±èƒ½è®¡ç®—å‡ºå‡†ç¡®åœ°å€
   - ä¾¿äºæå‰è§„åˆ’å’Œé›†æˆ

2. **ç¡®å®šæ€§**
   - ç›¸åŒçš„å‚æ•°æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„åœ°å€
   - ä¸å—nonceå˜åŒ–å½±å“

3. **çµæ´»æ€§**
   - å¯ä»¥é€‰æ‹©æ€§éƒ¨ç½²åˆçº¦
   - æ”¯æŒæ¡ä»¶éƒ¨ç½²ï¼ˆå¦‚äº‰è®®è§£å†³åœºæ™¯ï¼‰

**ä¸»è¦ç”¨ä¾‹**

**é“¾å¤–ä»²è£åˆçº¦**ï¼š
- åŒæ–¹çº¦å®šä¸€ä¸ªä»²è£åˆçº¦åœ°å€
- åªæœ‰å‘ç”Ÿäº‰è®®æ—¶æ‰å®é™…éƒ¨ç½²
- èŠ‚çœgasè´¹ç”¨ï¼Œæé«˜æ•ˆç‡

è¿™ç§æœºåˆ¶ç‰¹åˆ«é€‚åˆéœ€è¦**é¢„å…ˆç¡®å®šåˆçº¦åœ°å€**ä½†**å»¶è¿Ÿéƒ¨ç½²**çš„åœºæ™¯ï¼Œæ¯”å¦‚çŠ¶æ€é€šé“ã€æ”¯ä»˜é€šé“ç­‰Layer 2è§£å†³æ–¹æ¡ˆã€‚


#### ç±»å‹è½¬æ¢è¿‡ç¨‹è¯¦è§£

**æ•°æ®æµè½¬è¿‡ç¨‹**

```
è¾“å…¥æ•°æ®
    â†“
abi.encodePacked() â†’ bytes (åŠ¨æ€é•¿åº¦å­—èŠ‚æ•°ç»„)
    â†“
keccak256() â†’ bytes32 (32å­—èŠ‚å“ˆå¸Œ)
    â†“
uint() â†’ uint256 (256ä½æ•´æ•°)
    â†“
uint160() â†’ uint160 (160ä½æ•´æ•°ï¼Œæˆªå–ä½160ä½)
    â†“
address() â†’ address (20å­—èŠ‚åœ°å€)
```

**æ¯æ­¥è½¬æ¢çš„ä½œç”¨**

| æ­¥éª¤ | è¾“å…¥ç±»å‹ | è¾“å‡ºç±»å‹ | ä½œç”¨ | ç¤ºä¾‹ |
|------|----------|----------|------|------|
| 1 | å„ç§ç±»å‹ | `bytes` | æ•°æ®æ‰“åŒ… | `0xff` + åœ°å€ + salt + å“ˆå¸Œ |
| 2 | `bytes` | `bytes32` | å“ˆå¸Œè®¡ç®— | `0x1234...abcd` (64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦) |
| 3 | `bytes32` | `uint256` | è½¬ä¸ºæ•´æ•° | `123456789012345678901234567890...` |
| 4 | `uint256` | `uint160` | æˆªå–160ä½ | åªä¿ç•™å40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ |
| 5 | `uint160` | `address` | è½¬ä¸ºåœ°å€ | `0x1234567890123456789012345678901234567890` |

**ä¸ºä»€ä¹ˆæ˜¯160ä½ï¼Ÿ**

ä»¥å¤ªåŠåœ°å€è®¾è®¡ï¼š
- **é•¿åº¦**ï¼š20å­—èŠ‚ = 160ä½ = 40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦
- **æ ¼å¼**ï¼š`0x` + 40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦
- **ç¤ºä¾‹**ï¼š`0x742d35Cc6634C0532925a3b8D45C1A87c9e64D4F`

**å†…å­˜ä¸­çš„æ•°æ®å˜åŒ–**

```
åŸå§‹å“ˆå¸Œï¼ˆ256ä½ï¼‰ï¼š
0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

æˆªå–ä¸º160ä½ï¼š
                                        â†“ ä»è¿™é‡Œå¼€å§‹å–160ä½
0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
                                        â†“
æœ€ç»ˆåœ°å€ï¼š0x567890abcdef1234567890abcdef1234567890abcdef
```

**ä¸€æ­¥æ­¥éªŒè¯**

å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼éªŒè¯æ¯ä¸€æ­¥ï¼š

```solidity
// åˆ†æ­¥éª¤è®¡ç®—
bytes memory packed = abi.encodePacked(bytes1(0xff), address(this), salt, codeHash);
bytes32 hash = keccak256(packed);
uint256 hashAsUint = uint256(hash);
uint160 addressAsUint = uint160(hashAsUint);  // è‡ªåŠ¨æˆªå–ä½160ä½
address finalAddress = address(addressAsUint);
```

### èµ‹å€¼

- https://docs.soliditylang.org/zh-cn/latest/control-structures.html#index-4

#### è§£æ„èµ‹å€¼å’Œè¿”å›å¤šä¸ªå€¼

**å…ƒç»„(Tuple)**

- ç¼–è¯‘æ—¶å…ƒç´ æ•°é‡å›ºå®šçš„å¯¹è±¡åˆ—è¡¨
- å…ƒç´ å¯ä»¥æ˜¯ä¸åŒç±»å‹
- åŒæ—¶è¿”å›æˆ–èµ‹å€¼å¤šä¸ªæ•°å€¼
- å…ƒç»„ä¸æ˜¯çœŸæ­£çš„ç±»å‹ï¼Œåªæ˜¯è¯­æ³•åˆ†ç»„å·¥å…·

**åœºæ™¯*

æ¨¡å¼1ï¼šå…¨éƒ¨å£°æ˜æ–°å˜é‡

```solidity
(uint a, string memory b, bool c) = getValues();
```

æ¨¡å¼2ï¼šå…¨éƒ¨ä½¿ç”¨å·²å­˜åœ¨çš„å˜é‡

```solidity
uint a;
string memory b;
bool c;
// ... å…¶ä»–ä»£ç  ...
(a, b, c) = getValues();
```

```solidity
(x, uint y) = (1, 2); âŒ
```

#### ä½œç”¨åŸŸå’Œå£°æ˜

##### ç¬¬ä¸€ä¸ªä¾‹å­ï¼šæ­£å¸¸çš„å—çº§ä½œç”¨åŸŸ

```solidity
contract C {
    function minimalScoping() pure public {
        {
            uint same;
            same = 1;
        }

        {
            uint same;
            same = 3;
        }
    }
}
```

:::tip
è§£æï¼š
- **ä¸¤ä¸ªç‹¬ç«‹çš„å—ä½œç”¨åŸŸ**ï¼šæ¯ä¸ª `{}` åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ä½œç”¨åŸŸ
- **å˜é‡åå¯ä»¥é‡å¤**ï¼šåœ¨ä¸åŒä½œç”¨åŸŸä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç›¸åŒçš„å˜é‡å `same`
- **ä½œç”¨åŸŸéš”ç¦»**ï¼šç¬¬ä¸€ä¸ªå—ä¸­çš„ `same` å’Œç¬¬äºŒä¸ªå—ä¸­çš„ `same` æ˜¯å®Œå…¨ä¸åŒçš„å˜é‡
- **å†…å­˜ç®¡ç†**ï¼šæ¯ä¸ªå˜é‡åœ¨å…¶ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨é”€æ¯

**æ‰§è¡Œæµç¨‹ï¼š**
1. è¿›å…¥ç¬¬ä¸€ä¸ªå—ï¼Œåˆ›å»º `uint same`ï¼Œèµ‹å€¼ä¸º 1
2. é€€å‡ºç¬¬ä¸€ä¸ªå—ï¼Œç¬¬ä¸€ä¸ª `same` è¢«é”€æ¯
3. è¿›å…¥ç¬¬äºŒä¸ªå—ï¼Œåˆ›å»ºæ–°çš„ `uint same`ï¼Œèµ‹å€¼ä¸º 3
4. é€€å‡ºç¬¬äºŒä¸ªå—ï¼Œç¬¬äºŒä¸ª `same` è¢«é”€æ¯
:::

##### ç¬¬äºŒä¸ªä¾‹å­ï¼šå˜é‡é®è”½ï¼ˆShadowingï¼‰é—®é¢˜

```solidity
uint x = 1;
{
    x = 2;            // ä¿®æ”¹å¤–å±‚ x ä¸º 2
    uint x;           // å†…å±‚ x å£°æ˜ï¼ˆé»˜è®¤å€¼ 0ï¼‰ï¼Œé®è”½å¤–å±‚ x
}                     // å†…å±‚ x é”€æ¯
return x;             // è¿”å›å¤–å±‚ xï¼ˆå€¼ä¸º 2ï¼‰
```

